

[env:esp32dev]
platform = espressif32
board = esp32dev
framework = arduino
board_build.partitions = partitions.csv

# NimBLE-Arduino: lightweight BLE stack (~30-40KB less RAM than Bluedroid)
lib_deps = 
	h2zero/NimBLE-Arduino@^1.4.0

# PRODUCTION BUILD - SIZE OPTIMIZATIONS
build_flags = 
	# Debug level - increase for development (0 = no logs, 5 = max verbosity)
	-DCORE_DEBUG_LEVEL=3
    
	# Size optimization instead of speed
	-Os
    
	# Remove unused functions/data sections
	-ffunction-sections
	-fdata-sections
	-Wl,--gc-sections
    
	# Disable unused Arduino features
	-DARDUINO_USB_MODE=0
	-DARDUINO_USB_CDC_ON_BOOT=0
    
	# C++ optimizations - we removed -fno-exceptions for stability
	# -fno-exceptions      # DISABLED - caused abort() and heap corruption
	# -fno-rtti            # DISABLED - for reliability
	-fno-threadsafe-statics  # Kept - safe
    
	# Additional optimizations
	-fmerge-all-constants
	-DDISABLE_ALL_LIBRARY_WARNINGS

	# NimBLE memory optimizations (disable unused roles for ~10KB extra savings)
	-DCONFIG_BT_NIMBLE_MAX_CONNECTIONS=1
	-DCONFIG_BT_NIMBLE_ROLE_CENTRAL_DISABLED
	-DCONFIG_BT_NIMBLE_ROLE_OBSERVER_DISABLED

	# NimBLE host task stack: increased from 4KB to 8KB to prevent
	# stack overflow when FileCommands runs SD/FATFS/SPI operations
	# inside BLE onWrite callback (see: Stack canary watchpoint triggered nimble_host)
	-DCONFIG_BT_NIMBLE_HOST_TASK_STACK_SIZE=8192

	# Allow including headers colocated inside src/ (migration shim)
	-I src

# build_unflags removed - we keep exceptions enabled for stability
# build_unflags = 
# 	-fexceptions
# 	-frtti

# Exclude HttpsOTAUpdate.cpp (needs esp_https_ota.h, IDF-only)
extra_scripts = pre:filter_https_ota.py

# Disable unused libraries (Update kept for BLE OTA support)
lib_ignore = 
	HTTPUpdate

; monitor_filters = esp32_exception_decoder
; build_type = debug

monitor_speed = 115200
monitor_filters = 
	esp32_exception_decoder
	time